from typing import List

class Solution:
    def braceExpansionII(self, expression: str) -> List[str]:

        def parse_expression(i):
            res, i = parse_term(i)
            while i < len(expression) and expression[i] == ',':
                i += 1
                next_res, i = parse_term(i)
                res |= next_res
            return res, i

        def parse_term(i):
            res = {""}
            while i < len(expression) and expression[i] not in '},':
                part, i = parse_factor(i)
                res = {a + b for a in res for b in part}
            return res, i

        def parse_factor(i):
            if expression[i] == '{':
                i += 1
                res, i = parse_expression(i)
                i += 1
                return res, i
            else:
                return {expression[i]}, i + 1

        result, _ = parse_expression(0)
        return sorted(result)
